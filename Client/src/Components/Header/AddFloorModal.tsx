"use client"

import type React from "react"
import type { User } from "../../Types/User"
import { useState } from "react"
import { useNavigate, useParams } from "react-router-dom";
import { toast } from "react-hot-toast";
import floorApi from "../../Api/parkingFloorApi";
import parkingAreaApi from "../../Api/parkingAreaApi";
import parkingSpotApi from "../../Api/parkingSpotApi";


interface Zone {
  id: number
  areaName: string
  description: string
  spotCount: number
}

interface AddFloorModalProps {
  isOpen: boolean
  onClose: () => void
  onAddFloor: (floorName: string, zones: Zone[]) => void
  existingFloors: string[]
  user: User | null
  setUser: React.Dispatch<React.SetStateAction<User | null>>
  lotId?: string | number  // ‚úÖ th√™m prop n√†y
}

const XIcon = () => (
  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
  </svg>
)

export default function AddFloorModal({
  isOpen,
  onClose,
  onAddFloor,
  existingFloors,
  user,
  setUser,
  lotId
}: AddFloorModalProps) {
  const [floorName, setFloorName] = useState("")
  const [error, setError] = useState("")
  const [zones, setZones] = useState<Zone[]>([])
  const [zoneCount, setZoneCount] = useState<number>(3) // s·ªë khu v·ª±c m·∫∑c ƒë·ªãnh khi th√™m
  const navigate = useNavigate();
  // üß© Th√™m nhi·ªÅu khu v·ª±c c√πng l√∫c
const handleAddZone = () => {
  // Lu√¥n b·∫Øt ƒë·∫ßu l·∫°i t·ª´ 'A'
  const newZones: Zone[] = Array.from({ length: zoneCount }, (_, i) => {
    const areaLetter = String.fromCharCode(65 + i); // 65 = 'A'
    return {
      id: Date.now() + i,
      areaName: areaLetter,
      description: "",
      spotCount: 0,
    };
  });

  // Ghi ƒë√® danh s√°ch khu v·ª±c c≈©, kh√¥ng c·ªông d·ªìn
  setZones(newZones);
};




  
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();

  if (!floorName.trim()) {
    toast.error("‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n t·∫ßng!");
    return;
  }

  if (existingFloors.includes(floorName.trim())) {
    toast.error("‚ö†Ô∏è T·∫ßng n√†y ƒë√£ t·ªìn t·∫°i!");
    return;
  }

  if (zones.length === 0) {
    toast.error("‚ö†Ô∏è Vui l√≤ng th√™m √≠t nh·∫•t 1 khu v·ª±c!");
    return;
  }

  try {


    if (!lotId) {
      toast.error("‚ùå Kh√¥ng t√¨m th·∫•y ID b√£i xe!");
      return;
    }

    // üîπ 2. T·∫°o t·∫ßng m·ªõi
    const newFloor = await floorApi.createFloor({
      lotId: Number(lotId),
      floorNumber: existingFloors.length + 1, // ho·∫∑c c√≥ th·ªÉ d√πng t√™n t·∫ßng n·∫øu b·∫°n mu·ªën
      description: `T·∫ßng ${floorName}`,
    });

    const floorId = newFloor.floorId;
    if (!floorId) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c floorId t·ª´ backend");

    // üîπ 3. T·∫°o khu v·ª±c + ch·ªó ƒë·ªó trong t·∫ßng m·ªõi
    for (const zone of zones) {
      const newArea = await parkingAreaApi.createParkingArea({
        floorId,
        areaName: zone.areaName,
        description: zone.description,
        spotCount: zone.spotCount,
      });

      if (newArea.areaId && zone.spotCount > 0) {
        for (let i = 1; i <= zone.spotCount; i++) {
          const spotCode = `${zone.areaName}${i}`;
          await parkingSpotApi.createParkingSpot({
            areaId: newArea.areaId,
            spotCode,
            status: "Empty",
          });
        }
      }
    }

    toast.success(`üéâ ƒê√£ th√™m t·∫ßng "${floorName}" th√†nh c√¥ng!`);
    onAddFloor(floorName.trim(), zones);
    onClose();
    setTimeout(() => {
  window.location.reload();
}, 1000); // ƒë·ª£i 1 gi√¢y cho toast hi·ªÉn th·ªã r·ªìi reload

  } catch (error: any) {
    console.error(error);
    toast.error("‚ùå L·ªói khi th√™m t·∫ßng: " + error.message);
  }
};


  // üß© C·∫≠p nh·∫≠t khu v·ª±c
  const handleZoneChange = (id: number, key: keyof Zone, value: string | number) => {
    setZones((prev) =>
      prev.map((z) => (z.id === id ? { ...z, [key]: value } : z))
    )
  }

  // üß© X√≥a khu v·ª±c
  const handleDeleteZone = (id: number) => {
    setZones((prev) => prev.filter((z) => z.id !== id))
  }



  const handleClose = () => {
    setFloorName("")
    setZones([])
    setError("")
    onClose()
  }

  if (!isOpen) return null

  return (
    <>
      {user ? (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          {/* Backdrop */}
          <div
            className="absolute inset-0 bg-black/50 backdrop-blur-sm"
            onClick={handleClose}
          />

          {/* Modal */}
   <div
  className="relative bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4 z-50 max-h-[80vh] overflow-y-auto"
  onClick={(e) => e.stopPropagation()}
>

            {/* Header */}
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-semibold text-gray-800">Th√™m t·∫ßng m·ªõi</h2>
              <button
                onClick={handleClose}
                className="p-1 text-gray-400 hover:text-gray-600 transition-colors"
              >
                <XIcon />
              </button>
            </div>

            {/* Form */}
            <form onSubmit={handleSubmit}>
              {/* Nh·∫≠p t√™n t·∫ßng */}
              <div className="mb-4">
                <label
                  htmlFor="floorName"
                  className="block text-sm font-medium text-gray-700 mb-2"
                >
                  T√™n t·∫ßng
                </label>
                <input
                  type="text"
                  id="floorName"
                  value={floorName}
                  onChange={(e) => {
                    setFloorName(e.target.value)
                    setError("")
                  }}
                  placeholder="e.g., B6, L1, P1"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#a9a4eb]"
                />
                {error && <p className="mt-1 text-sm text-red-600">{error}</p>}
              </div>

              {/* Danh s√°ch t·∫ßng hi·ªán c√≥ */}
              <div className="mb-6">
                <p className="text-sm text-gray-600 mb-2">Nh·ªØng t·∫ßng ƒëang c√≥:</p>
                <div className="flex flex-wrap gap-2">
                  {existingFloors.map((floor) => (
                    <span
                      key={floor}
                      className="px-2 py-1 bg-gradient-to-r from-[#a9a4eb] to-[#6A63F0] text-white text-xs rounded"
                    >
                      {floor}
                    </span>
                  ))}
                </div>
              </div>

              {/* Khu v·ª±c trong t·∫ßng */}
              <div className="mb-4">
                <div className="flex justify-between items-center mb-2">
                  <h3 className="text-sm font-medium text-gray-700">Khu v·ª±c</h3>
                  <div className="flex items-center gap-2">
                    <select
                      value={zoneCount}
                      onChange={(e) => setZoneCount(Number(e.target.value))}
                      className="border border-gray-300 rounded px-2 py-1 text-sm"
                    >
                      <option value={3}>3 khu v·ª±c</option>
                      <option value={6}>6 khu v·ª±c</option>
                      <option value={9}>9 khu v·ª±c</option>
                    </select>
                    <button
                      type="button"
                      onClick={handleAddZone}
                      className="text-sm text-[#6A63F0] hover:underline"
                    >
                      + Th√™m
                    </button>
                  </div>
                </div>

                {zones.length === 0 ? (
                  <p className="text-sm text-gray-400">Ch∆∞a c√≥ khu v·ª±c n√†o</p>
                ) : (
                  zones.map((zone) => (
                    <div
                      key={zone.id}
                      className="flex flex-col gap-2 mb-3 border p-3 rounded-lg"
                    >
                      <div className="flex gap-2">
                        <input
                          type="text"
                          value={zone.areaName}
                          onChange={(e) =>
                            handleZoneChange(zone.id, "areaName", e.target.value)
                          }
                          placeholder="T√™n khu v·ª±c"
                          className="flex-1 px-2 py-1 border border-gray-300 rounded"
                        />
                        <select
                          value={zone.spotCount}
                          onChange={(e) =>
                            handleZoneChange(zone.id, "spotCount", Number(e.target.value))
                          }
                          className="px-2 py-1 border border-gray-300 rounded w-24"
                        >
                          <option value={0}>S·ªë ch·ªó</option>
                          <option value={2}>2</option>
                          <option value={4}>4</option>
                          <option value={6}>6</option>
                          <option value={8}>8</option>
                        </select>
                        <button
                          type="button"
                          onClick={() => handleDeleteZone(zone.id)}
                          className="text-red-500 hover:text-red-700"
                        >
                          ‚úï
                        </button>
                      </div>

                      <textarea
                        value={zone.description}
                        onChange={(e) =>
                          handleZoneChange(zone.id, "description", e.target.value)
                        }
                        placeholder="M√¥ t·∫£ khu v·ª±c (v√≠ d·ª•: khu xe m√°y, khu √¥ t√¥...)"
                        className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                      />
                    </div>
                  ))
                )}
              </div>

              {/* N√∫t h√†nh ƒë·ªông */}
              <div className="flex space-x-3">
                <button
                  type="button"
                  onClick={handleClose}
                  className="flex-1 px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                >
                  H·ªßy
                </button>
                <button
                  type="submit"
                  className="flex-1 px-4 py-2 bg-gradient-to-r from-[#a9a4eb] to-[#6A63F0] text-white rounded-lg transition-colors"
                >
                  Th√™m t·∫ßng
                </button>
              </div>
            </form>
          </div>
        </div>
      ) : (
        <h2 className="text-xl text-gray-500">Ch∆∞a ƒëƒÉng nh·∫≠p</h2>
      )}
    </>
  )
}
